<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HRM — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>
        <div class="flex-grow-1">
            <div class="mb-4">
                <h2 class="fw-bold mb-0">HR & Payroll</h2><small class="text-muted">Manage employees, salary, and
                    incentives</small>
            </div>

            <ul class="nav nav-tabs mb-3" id="hrmTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-emp"><i
                            class="bi bi-person-badge me-1"></i>Employees</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-salary" id="salary-tab-link"><i
                            class="bi bi-cash-stack me-1"></i>Salary</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-incentives"
                        id="incentive-tab-link"><i class="bi bi-trophy me-1"></i>Incentives</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-content">
                    <!-- Employees Tab -->
                    <div class="tab-pane fade show active" id="tab-emp">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-0">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Employee Details</th>
                                            <th>Role / Dept</th>
                                            <th>Referral Code</th>
                                            <th>Workload</th>
                                            <th>Net Salary (Est.)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emp-table">
                                        <tr>
                                            <td colspan="6" class="text-center py-5 text-muted">
                                                <div class="spinner-border spinner-border-sm me-2"></div>
                                                Searching workforce...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ID Card Modal -->
                    <div class="modal fade" id="idCardModal" tabindex="-1">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content" style="border-radius: 12px; overflow: hidden;">
                                <div class="p-4 text-center bg-primary text-white">
                                    <h6 class="fw-bold mb-0">COMPANY IDENTITY CARD</h6>
                                    <div class="mt-3 mx-auto rounded-circle bg-white border border-4 border-white overflow-hidden shadow"
                                        style="width:100px; height:100px;">
                                        <img id="id-photo" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"
                                            class="w-100">
                                    </div>
                                </div>
                                <div class="modal-body text-center py-4 bg-white">
                                    <h5 id="id-name" class="fw-bold text-dark mb-1">...</h5>
                                    <div id="id-role" class="text-primary small fw-bold mb-3 uppercase">PROJECT MANAGER
                                    </div>
                                    <hr class="mx-4 opacity-10">
                                    <div class="row g-0 mt-3">
                                        <div class="col-6 border-end text-muted small">EMP ID<br><span id="id-number"
                                                class="fw-bold text-dark">#SETS-220</span></div>
                                        <div class="col-6 text-muted small">JOINED<br><span
                                                class="fw-bold text-dark">JAN 2024</span></div>
                                    </div>
                                    <div class="mt-4">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=EMP_VERIFIED"
                                            class="border p-1 rounded">
                                    </div>
                                </div>
                                <div class="modal-footer bg-light py-2">
                                    <button class="btn btn-sm btn-outline-primary w-100"
                                        onclick="window.print()">Download PDF</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Salary Tab -->
                    <div class="tab-pane fade" id="tab-salary">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-0">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Employee</th>
                                            <th>Month / Year</th>
                                            <th>Fixed Salary</th>
                                            <th>Incentives Earned</th>
                                            <th>Total Payout</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salary-table">
                                        <tr>
                                            <td colspan="6" class="text-center py-5 text-muted">Awaiting payroll
                                                sweep...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Incentives Tab -->
                    <div class="tab-pane fade" id="tab-incentives">
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-0">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Min Volume</th>
                                            <th>Max Volume</th>
                                            <th>Rate per Lead</th>
                                            <th>Incentive Description</th>
                                        </tr>
                                    </thead>
                                    <tbody id="incentive-table">
                                        <tr>
                                            <td colspan="4" class="text-center py-5 text-muted">Calculating tiers...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../js/api.js"></script>
        <script src="../js/components.js"></script><script src="../js/auth.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            requireAuth();
            document.getElementById('sidebar').innerHTML = renderSidebar('hrm');

            async function loadEmployees() {
                try {
                    const emps = await apiGet('/employees/');
                    document.getElementById('emp-table').innerHTML = emps.length
                        ? emps.map(e => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-circle">
                                    ${(e.full_name || e.name || 'E')[0]}
                                </div>
                                <div>
                                    <div class="fw-bold">${e.full_name || e.name || '—'}</div>
                                    <div class="text-muted small">${e.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="badge bg-light text-primary border border-primary-subtle">${(e.role || '—').replace(/_/g, ' ')}</div>
                            <div class="text-muted small mt-1">${e.department || 'General'}</div>
                        </td>
                        <td>
                            <code class="text-primary fw-bold" title="Click to copy">${e.referral_code || 'SETU_REF_0' + e.id}</code>
                            <button class="btn btn-sm py-0" onclick="copyRef('${e.referral_code}')"><i class="bi bi-copy"></i></button>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="height: 6px;">
                                    <div class="progress-bar" style="width: ${(e.active_clients_count || 0) * 10}%"></div>
                                </div>
                                <span class="small fw-semibold text-muted">${e.active_clients_count || 0} Clients</span>
                            </div>
                        </td>
                        <td class="fw-bold text-dark">₹${(Number(e.base_salary || 0) + 1200).toLocaleString('en-IN')}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-dark" onclick="viewIdCard(${e.id}, '${e.name}')">
                                    <i class="bi bi-person-vcard me-1"></i>ID Card
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${e.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`).join('')
                        : '<tr><td colspan="6" class="text-center py-5 text-muted">No operational staff found.</td></tr>';
                } catch (err) {
                    document.getElementById('emp-table').innerHTML = `<tr><td colspan="6" class="text-center py-5 text-danger">HR System Error: ${err.message}</td></tr>`;
                }
            }

            window.viewIdCard = async (id, name) => {
                try {
                    const data = await apiGet(`/idcards/${id}`);
                    document.getElementById('id-name').textContent = data.employee_name;
                    document.getElementById('id-number').textContent = data.employee_code;
                    document.getElementById('id-role').textContent = data.role.replace(/_/g, ' ');
                    document.getElementById('id-photo').src = data.photo_url;

                    // Update QR Code
                    const qrImg = document.querySelector('#idCardModal img[src*="qrserver"]');
                    if (qrImg) {
                        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(data.qr_data)}`;
                    }

                    const modal = new bootstrap.Modal(document.getElementById('idCardModal'));
                    modal.show();
                } catch (err) {
                    showToast('Failed to load ID card data', 'error');
                }
            };

            window.copyRef = (code) => {
                if (!code || code === 'undefined') {
                    showToast('Wait for referral code to be generated', 'info');
                    return;
                }
                navigator.clipboard.writeText(code);
                showToast('Referral link copied to clipboard!', 'info');
            };

            window.deleteEmployee = async (id) => {
                if (!confirm('Are you sure you want to remove this employee?')) return;
                try {
                    await apiFetch(`/employees/${id}`, { method: 'DELETE' });
                    showToast('Employee deleted successfully', 'success');
                    loadEmployees();
                } catch (e) {
                    showToast(e.message || 'Failed to delete employee', 'error');
                }
            };

            // Tab loading logic: Fetch real salary slips
            document.getElementById('salary-tab-link').addEventListener('click', async () => {
                try {
                    const emps = await apiGet('/employees/');
                    let tableHtml = '';
                    for (const e of emps) {
                        const slips = await apiGet(`/hrm/salary/${e.id}`).catch(() => []);
                        if (slips.length > 0) {
                            slips.forEach(s => {
                                tableHtml += `
                                <tr>
                                    <td class="fw-semibold">${e.name || e.full_name}</td>
                                    <td>${s.month}</td>
                                    <td>₹${s.base_salary.toLocaleString('en-IN')}</td>
                                    <td class="text-danger">- ₹${s.deduction_amount.toLocaleString('en-IN')} (Leaves: ${s.unpaid_leaves})</td>
                                    <td class="fw-bold">₹${s.final_salary.toLocaleString('en-IN')}</td>
                                    <td><span class="badge bg-success-subtle text-success">Generated</span></td>
                                </tr>`;
                            });
                        }
                    }
                    document.getElementById('salary-table').innerHTML = tableHtml || '<tr><td colspan="6" class="text-center py-4">No payroll slips generated yet.</td></tr>';
                } catch (e) {
                    document.getElementById('salary-table').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load salary data</td></tr>';
                }
            });

            loadEmployees();
        </script>
        <style>
            .avatar-circle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #eef2ff;
                color: #4338ca;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
            }
        </style>


        <script>
            let incentiveLoaded = false;
            document.getElementById('incentive-tab-link').addEventListener('click', async () => {
                if (incentiveLoaded) return;
                incentiveLoaded = true;
                try {
                    const slabs = await apiGet('/incentives/slabs');
                    document.getElementById('incentive-table').innerHTML = slabs.length
                        ? slabs.map(s => `
        <tr>
            <td>${s.min_percentage}%</td>
            <td>${s.max_percentage != null ? s.max_percentage + '%' : 'No limit'}</td>
            <td class="fw-bold">Rs. ${s.amount_per_unit} / unit</td>
            <td class="text-muted">${s.description || '—'}</td>
        </tr>`).join('')
                        : `<tr>
                            <td colspan="4" class="text-center py-5 text-muted">No incentive slabs defined. Admin creates them via the
                                backend.</td>
                        </tr>`;
                } catch (e) { }
            });
        </script>
</body>

</html>
