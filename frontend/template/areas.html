<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Areas — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>
        <div class="flex-grow-1">
            <!-- The top header is automatically injected here by js/auth.js -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold fs-3 mb-1">Areas & Shops</h2>
                    <small class="text-muted" id="area-count"></small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addShopModal">
                        <i class="bi bi-shop me-1"></i>Add Shop
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAreaModal">
                        <i class="bi bi-plus-lg me-1"></i>New Area
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="areaTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-areas">Areas</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-shops">Shops</a></li>
            </ul>

            <div class="tab-content">
                <!-- Areas Tab -->
                <div class="tab-pane fade show active" id="tab-areas">
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Area Name</th>
                                        <th>Description</th>
                                        <th>Shops</th>
                                    </tr>
                                </thead>
                                <tbody id="areas-table">
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Shops Tab -->
                <div class="tab-pane fade" id="tab-shops">
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Shop Name</th>
                                        <th>Area</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shops-table">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Area Modal -->
    <div class="modal fade" id="addAreaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">New Area</h5><button class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Area Name *</label><input id="a-name"
                            class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Description</label><textarea id="a-desc"
                            class="form-control" rows="2"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="save-area-btn">Create Area</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Shop Modal -->
    <div class="modal fade" id="addShopModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Add Shop</h5><button class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Shop Name *</label><input id="s-name"
                            class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Area *</label>
                        <select id="s-area" class="form-select" required>
                            <option value="">Loading areas...</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Address</label><input id="s-addr" class="form-control">
                    </div>
                    <div class="mb-3"><label class="form-label">Phone</label><input id="s-phone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="save-shop-btn">Add Shop</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        requireAuth();
        document.getElementById('sidebar').innerHTML = renderSidebar('areas');

        let areas = [];

        async function loadAreas() {
            areas = await apiGet('/areas/');
            document.getElementById('area-count').textContent = `${areas.length} areas`;
            document.getElementById('areas-table').innerHTML = areas.length
                ? areas.map((a, i) => `<tr><td>${a.id}</td><td class="fw-semibold">${a.name}</td><td class="text-muted">${a.description || '—'}</td><td>${a.shops_count ?? '—'}</td></tr>`).join('')
                : '<tr><td colspan="4" class="text-center py-4 text-muted">No areas yet.</td></tr>';
            document.getElementById('s-area').innerHTML = '<option value="">-- Select Area --</option>' +
                areas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        async function loadShops() {
            const shops = await apiGet('/shops/?limit=200');
            document.getElementById('shops-table').innerHTML = shops.length
                ? shops.map(s => `
                <tr>
                    <td class="fw-semibold">${s.name}</td>
                    <td>${s.area_name || 'Area #' + s.area_id}</td>
                    <td class="text-muted small">${s.address || '—'}</td>
                    <td>${s.phone || '—'}</td>
                    <td><span class="badge ${s.is_active ? 'badge-success' : 'bg-secondary text-white'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteShop(${s.id})" title="Delete Shop"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`).join('')
                : '<tr><td colspan="6" class="text-center py-4 text-muted">No shops yet.</td></tr>';
        }

        document.getElementById('save-area-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-area-btn');
            btn.disabled = true;
            try {
                await apiPost('/areas/', { name: document.getElementById('a-name').value, description: document.getElementById('a-desc').value });
                bootstrap.Modal.getInstance(document.getElementById('addAreaModal')).hide();
                showToast('Area created!');
                loadAreas();
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        });

        document.getElementById('save-shop-btn').addEventListener('click', async () => {
            const areaId = document.getElementById('s-area').value;
            if (!areaId) return showToast('Select an area', 'error');
            const btn = document.getElementById('save-shop-btn');
            btn.disabled = true;
            try {
                await apiPost('/shops/', { name: document.getElementById('s-name').value, area_id: parseInt(areaId), address: document.getElementById('s-addr').value, phone: document.getElementById('s-phone').value });
                bootstrap.Modal.getInstance(document.getElementById('addShopModal')).hide();
                showToast('Shop added!');
                loadShops();
            } catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        });

        window.deleteShop = async (id) => {
            if (!confirm('Are you sure you want to delete this shop?')) return;
            try {
                await ApiClient.deleteShop(id);
                showToast('Shop deleted successfully', 'success');
                loadShops();
            } catch (e) {
                showToast(e.message || 'Failed to delete shop', 'error');
            }
        };

        loadAreas();
        loadShops();
    </script>
</body>

</html>