<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>
        <div class="flex-grow-1">
            <!-- Top header is auto-injected by js/auth.js -->
            <div class="mb-4">
                <h2 class="fw-bold fs-3 mb-1"><i class="bi bi-shield-lock me-2 text-danger"></i>Admin Console</h2>
                <small class="text-muted">User management and system access control</small>
            </div>

            <ul class="nav nav-tabs mb-3">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-users">Users & Roles</a>
                </li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-logs"
                        id="logs-tab-link">Activity Logs</a></li>
            </ul>

            <div class="tab-content">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="tab-users">
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Change Role</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activity Logs Tab -->
                <div class="tab-pane fade" id="tab-logs">
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <table class="table align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Entity</th>
                                        <th>Detail</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-table">
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        requireAuth();
        document.getElementById('sidebar').innerHTML = renderSidebar('admin');

        const ROLES = ['ADMIN', 'SALES', 'TELESALES', 'PROJECT_MANAGER', 'PROJECT_MANAGER_AND_SALES'];
        const roleColor = { ADMIN: 'danger', SALES: 'success', TELESALES: 'info', PROJECT_MANAGER: 'warning', PROJECT_MANAGER_AND_SALES: 'primary' };

        async function loadUsers() {
            const emps = await apiGet('/employees/');
            document.getElementById('users-table').innerHTML = emps.length
                ? emps.map(u => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary fw-bold d-flex align-items-center justify-content-center" style="width:34px;height:34px;">${(u.full_name || u.name || '?')[0].toUpperCase()}</div>
                            <div class="fw-semibold">${u.full_name || u.name || '—'}</div>
                        </div>
                    </td>
                    <td class="text-muted small">${u.email || '—'}</td>
                    <td><span class="badge badge-primary">${(u.role || '—').replace(/_/g, ' ')}</span></td>
                    <td><span class="badge ${u.is_active ? 'badge-success' : 'bg-secondary text-white'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <select class="form-select form-select-sm" style="max-width:200px;" onchange="changeRole(${u.user_id || u.id}, this.value)">
                            ${ROLES.map(r => `<option value="${r}" ${r === u.role ? 'selected' : ''}>${r.replace(/_/g, ' ')}</option>`).join('')}
                        </select>
                    </td>
                </tr>`).join('')
                : '<tr><td colspan="5" class="text-center py-5 text-muted">No users found.</td></tr>';
        }

        window.changeRole = async (userId, role) => {
            try {
                await apiPatch(`/users/${userId}/role`, { role });
                showToast('Role updated!');
            } catch (e) { showToast(e.message, 'error'); }
        };

        let logsLoaded = false;
        document.getElementById('logs-tab-link').addEventListener('click', async () => {
            if (logsLoaded) return;
            logsLoaded = true;
            try {
                const logs = await apiGet('/activity-logs/?limit=100');
                document.getElementById('logs-table').innerHTML = logs.length
                    ? logs.map(l => `
                    <tr>
                        <td class="fw-semibold">${l.user_name || '#' + l.user_id}</td>
                        <td><span class="badge bg-secondary">${l.action || '?'}</span></td>
                        <td>${l.entity_type || '—'}</td>
                        <td class="text-muted small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l.details || '—'}</td>
                        <td class="text-muted small">${l.created_at ? new Date(l.created_at).toLocaleString('en-IN') : '—'}</td>
                    </tr>`).join('')
                    : '<tr><td colspan="5" class="text-center py-5 text-muted">No activity logs yet.</td></tr>';
            } catch (e) { document.getElementById('logs-table').innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Access denied — Admin only</td></tr>`; }
        });

        loadUsers();
    </script>
</body>

</html>