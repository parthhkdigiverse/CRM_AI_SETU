<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visits — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>
        <div class="flex-grow-1">
            <!-- The top header is automatically injected here by js/auth.js -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold fs-3 mb-1">Shops & Leads Tracker</h2>
                    <small class="text-muted" id="visit-count"></small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="loadVisits()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logVisitModal">
                        <i class="bi bi-plus-lg me-1"></i>Update Shop Status
                    </button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Shop & Area</th>
                                <th>Assigned To</th>
                                <th>Last Activity</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Evidence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="visits-table">
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">
                                    <i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i>
                                    <p class="mt-2">Loading leads...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Visit Modal -->
    <div class="modal fade" id="logVisitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-geo-alt me-2"></i>Update Shop Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Target Shop *</label>
                        <select id="v-shop" class="form-select" required>
                            <option value="">Loading shops...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Interaction Outcome</label>
                        <select id="v-status" class="form-select">
                            <option value="SATISFIED">Satisfied</option>
                            <option value="ACCEPT">Accept (Gen. Bill)</option>
                            <option value="DECLINE">Decline</option>
                            <option value="THINKING">Taking time to think</option>
                            <option value="OTHER">Other</option>
                            <option value="SCHEDULED">Scheduled/Pending</option>
                        </select>
                    </div>
                    <div class="mb-3" id="other-status-div" style="display:none;">
                        <label class="form-label">Specify Other Status</label>
                        <input type="text" id="v-status-other" class="form-control" placeholder="Describe status...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Remarks / Reason</label>
                        <textarea id="v-remarks" class="form-control" rows="3"
                            placeholder="Detailed outcome or reason if declined..."></textarea>
                    </div>
                    <div class="mb-3" id="photo-upload-container">
                        <label class="form-label fw-semibold">Photo of Visited Shop</label>
                        <input type="file" id="v-photo" class="form-control" accept="image/*">
                        <small class="text-muted">Required for Sales role, not for Telesales.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="save-visit-btn">Save Progress</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/components.js?v=2.1"></script>
    <script src="../js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        requireAuth();
        document.getElementById('sidebar').innerHTML = renderSidebar('visits');

        const user = getUser();
        const isSales = user?.role === 'SALES' || user?.role === 'PROJECT_MANAGER_AND_SALES';
        const isTelesales = user?.role === 'TELESALES';

        // Hide photo upload for Telesales
        if (isTelesales) {
            document.getElementById('photo-upload-container').style.display = 'none';
        }

        // Handle "Other" status specification
        document.getElementById('v-status').addEventListener('change', (e) => {
            document.getElementById('other-status-div').style.display = e.target.value === 'OTHER' ? 'block' : 'none';
        });

        // Load shops into dropdown
        apiGet('/shops/').then(shops => {
            const sel = document.getElementById('v-shop');
            sel.innerHTML = '<option value="">-- Select Shop to Update --</option>' +
                shops.map(s => `<option value="${s.id}">${s.name} (${s.address || 'No Address'})</option>`).join('');
        }).catch(() => { });

        async function loadVisits() {
            try {
                const visits = await apiGet('/visits/?limit=200');
                document.getElementById('visit-count').textContent = `${visits.length} tracked activities`;

                const statusBadge = s => {
                    const map = {
                        SATISFIED: 'info',
                        ACCEPT: 'success',
                        DECLINE: 'danger',
                        THINKING: 'warning',
                        OTHER: 'secondary',
                        SCHEDULED: 'light text-dark border'
                    };
                    return map[s] || 'secondary';
                };

                document.getElementById('visits-table').innerHTML = visits.length
                    ? visits.map(v => `
                    <tr>
                        <td class="fw-semibold">
                            ${v.shop_name || 'Shop #' + v.shop_id}
                            <div class="text-muted x-small fw-normal">ID: ${v.shop_id}</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center text-primary" style="width:24px;height:24px;font-size:10px;font-weight:700;">
                                    ${(v.user_name || 'U')[0]}
                                </div>
                                <span>${v.user_name || '—'}</span>
                            </div>
                        </td>
                        <td>${v.visit_date ? new Date(v.visit_date).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }) : '—'}</td>
                        <td><span class="badge bg-${statusBadge(v.status)}">${v.status || '—'}</span></td>
                        <td class="text-muted small" style="max-width:200px; white-space: normal;">${v.notes || '—'}</td>
                        <td>
                            ${v.photo_url ? `<a href="${v.photo_url}" target="_blank" class="btn btn-sm btn-outline-primary py-0"><i class="bi bi-image"></i> View</a>` : '<span class="text-muted small">No photo</span>'}
                        </td>
                        <td>
                            ${v.status === 'ACCEPT' ? `<a href="clients.html" class="btn btn-sm btn-success"><i class="bi bi-receipt me-1"></i>Bill</a>` : ''}
                            <button class="btn btn-sm btn-light border" onclick="editVisit(${v.id})"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>`).join('')
                    : '<tr><td colspan="7" class="text-center py-5 text-muted">No activities recorded yet. Start by updating a shop status.</td></tr>';
            } catch (err) {
                document.getElementById('visits-table').innerHTML = `<tr><td colspan="7" class="text-center py-5 text-danger">Failed to load data: ${err.message}</td></tr>`;
            }
        }

        document.getElementById('save-visit-btn').addEventListener('click', async () => {
            const shopId = document.getElementById('v-shop').value;
            if (!shopId) return showToast('Please select a shop', 'error');

            const status = document.getElementById('v-status').value;
            const photo = document.getElementById('v-photo').files[0];

            if (isSales && !photo && status !== 'SCHEDULED') {
                showToast('Photo is required for Field Sales roles', 'error');
                btn.disabled = false; btn.textContent = 'Save Progress';
                return;
            }

            const btn = document.getElementById('save-visit-btn');
            btn.disabled = true; btn.textContent = 'Processing...';

            const fd = new FormData();
            fd.append('shop_id', shopId);
            fd.append('status', status === 'OTHER' ? document.getElementById('v-status-other').value.toUpperCase() : status);
            fd.append('remarks', document.getElementById('v-remarks').value);

            // Auto date
            fd.append('visit_date', new Date().toISOString());

            if (photo) fd.append('photo', photo);

            try {
                await ApiClient.createVisit(fd);

                if (status === 'ACCEPT') {
                    showToast('Lead Accepted! Converting to client flow...', 'success');
                    setTimeout(() => window.location.href = 'clients.html', 1500);
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('logVisitModal')).hide();
                    showToast('Status updated successfully!');
                    loadVisits();
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Save Progress';
            }
        });

        loadVisits();
    </script>

</body>

</html>