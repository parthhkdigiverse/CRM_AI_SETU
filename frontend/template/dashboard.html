<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>

        <div class="flex-grow-1">
            <!-- Top header injected by auth.js -->

            <div class="page-content">

                <!-- Page Title -->
                <div class="mb-4">
                    <h2 class="fw-bold fs-3 mb-1">Dashboard</h2>
                    <p class="text-muted mb-0" style="font-size:0.93rem;">
                        Welcome back! Here's what's happening today — <span id="today-date"></span>
                    </p>
                </div>

                <!-- KPI Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-lg-3">
                        <a href="visits.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100" style="cursor:pointer;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="kpi-title">Total Leads</div>
                                    <div class="kpi-icon-wrapper icon-purple"><i class="bi bi-bullseye"></i></div>
                                </div>
                                <div class="kpi-value" id="kpi-leads">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend" id="kpi-leads-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-lg-3">
                        <a href="clients.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100" style="cursor:pointer;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="kpi-title">Active Clients</div>
                                    <div class="kpi-icon-wrapper icon-teal"><i class="bi bi-people-fill"></i></div>
                                </div>
                                <div class="kpi-value" id="kpi-clients">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend" id="kpi-clients-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-lg-3">
                        <a href="issues.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100" style="cursor:pointer;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="kpi-title">Open Issues</div>
                                    <div class="kpi-icon-wrapper icon-yellow"><i class="bi bi-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="kpi-value" id="kpi-issues">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend" id="kpi-issues-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-lg-3">
                        <a href="visits.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100" style="cursor:pointer;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="kpi-title">Total Visits</div>
                                    <div class="kpi-icon-wrapper icon-green"><i class="bi bi-geo-alt-fill"></i></div>
                                </div>
                                <div class="kpi-value" id="kpi-visits">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend" id="kpi-visits-trend">—</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-3 mb-4">
                    <!-- Bar: Visits/Leads by Month -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Leads by Month</h6>
                                <span class="badge rounded-pill"
                                    style="background:#eef2ff;color:#4f46e5;font-size:0.7rem;">Live</span>
                            </div>
                            <canvas id="leadsChart" height="230"></canvas>
                        </div>
                    </div>
                    <!-- Status Breakdown: Issues -->
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <h6 class="fw-bold mb-3">Issues by Severity</h6>
                            <canvas id="issuesChart" height="220"></canvas>
                            <div id="issues-legend" class="mt-3" style="font-size:0.78rem;"></div>
                        </div>
                    </div>
                    <!-- Lead Status Donut -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <h6 class="fw-bold mb-3">Lead Status Breakdown</h6>
                            <canvas id="leadStatusChart" height="200"></canvas>
                            <div id="lead-status-legend" class="d-flex flex-wrap gap-2 mt-3" style="font-size:0.78rem;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity + Tasks Row -->
                <div class="row g-3">
                    <!-- Recent Activity (from activity logs API) -->
                    <div class="col-md-7">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Recent Activity</h6>
                                <button onclick="loadActivity()" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;font-size:0.8rem;">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                            </div>
                            <div id="activity-feed">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm"></div>
                                    <p class="mt-2 small">Loading activity...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Open Issues Table -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Open Issues</h6>
                                <a href="issues.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;font-size:0.8rem;">View All</a>
                            </div>
                            <div id="open-issues-list">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients + Employees Row -->
                <div class="row g-3 mt-1">
                    <!-- Recent Clients -->
                    <div class="col-md-7">
                        <div class="card border-0 shadow-sm">
                            <div
                                class="card-header bg-white border-0 pt-4 pb-2 px-4 d-flex justify-content-between align-items-center">
                                <span class="fw-bold"><i class="bi bi-people me-2 text-primary"></i>Recent
                                    Clients</span>
                                <a href="clients.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <table class="table mb-0" style="font-size:0.875rem;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Organisation</th>
                                            <th>Status</th>
                                            <th>PM</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clients-table">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <div class="spinner-border spinner-border-sm"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Employees quick view -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm">
                            <div
                                class="card-header bg-white border-0 pt-4 pb-2 px-4 d-flex justify-content-between align-items-center">
                                <span class="fw-bold"><i class="bi bi-person-badge me-2 text-primary"></i>Team
                                    Members</span>
                                <a href="hrm.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;">HR &amp; Payroll</a>
                            </div>
                            <div class="card-body p-0">
                                <div id="employees-list" class="px-3 pb-3">
                                    <div class="text-center text-muted py-4">
                                        <div class="spinner-border spinner-border-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /page-content -->
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        requireAuth();
        document.getElementById('sidebar').innerHTML = renderSidebar('dashboard');
        document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        // ── Utility ─────────────────────────────────────────────────────
        function timeAgo(dateStr) {
            if (!dateStr) return '—';
            const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function sevBadge(sev) {
            const map = { HIGH: 'bg-danger', MEDIUM: 'bg-warning text-dark', LOW: 'bg-success' };
            return map[sev] || 'bg-secondary';
        }

        function statusBadge(status) {
            const map = {
                ACCEPT: 'badge-success', SATISFIED: 'badge-primary',
                DECLINE: 'badge-danger', THINKING: 'badge-warning',
                SCHEDULED: 'bg-info text-white', OTHER: 'bg-secondary'
            };
            return map[(status || '').toUpperCase()] || 'bg-secondary';
        }

        // ── Charts (now using backend-aggregated data) ──────────────────
        let leadsChart, issuesChart, leadStatusChart;

        function initCharts(stats) {
            // 1. Leads by Month (bar)
            const labels = Object.keys(stats.leads_by_month);
            const data = Object.values(stats.leads_by_month);

            if (leadsChart) leadsChart.destroy();
            leadsChart = new Chart(document.getElementById('leadsChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Visits/Leads', data,
                        backgroundColor: '#4f46e5', borderRadius: 5
                    }]
                },
                options: {
                    plugins: { legend: { display: false } }, scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });

            // 2. Issues by Severity (donut)
            const sevData = stats.issue_severity_breakdown;
            if (issuesChart) issuesChart.destroy();
            issuesChart = new Chart(document.getElementById('issuesChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sevData),
                    datasets: [{
                        data: Object.values(sevData),
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'], borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { display: false } }, cutout: '65%' }
            });
            document.getElementById('issues-legend').innerHTML = Object.entries(sevData).map(([l, v]) => {
                const colors = { HIGH: '#ef4444', MEDIUM: '#f59e0b', LOW: '#10b981' };
                return `<div class="d-flex align-items-center gap-1 mb-1">
                <span style="width:10px;height:10px;border-radius:50%;background:${colors[l] || '#94a3b8'};display:inline-block;flex-shrink:0;"></span>
                <span>${l}: <b>${v}</b></span></div>`;
            }).join('');

            // 3. Lead/Visit Status donut
            const stData = stats.visit_status_breakdown;
            const stColors = ['#10b981', '#4f46e5', '#ef4444', '#f59e0b', '#06b6d4', '#94a3b8'];
            if (leadStatusChart) leadStatusChart.destroy();
            leadStatusChart = new Chart(document.getElementById('leadStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stData),
                    datasets: [{ data: Object.values(stData), backgroundColor: stColors, borderWidth: 0 }]
                },
                options: { plugins: { legend: { display: false } }, cutout: '60%' }
            });
            document.getElementById('lead-status-legend').innerHTML = Object.keys(stData).map((s, i) =>
                `<span><span style="width:10px;height:10px;background:${stColors[i % stColors.length]};border-radius:50%;display:inline-block;"></span> ${s}: <b>${stData[s]}</b></span>`
            ).join(' ');
        }

        // ── Activity Feed ─────────────────────────────────────────────────
        const ACTION_META = {
            CREATE: { icon: 'bi-plus-circle-fill', cls: 'purple', label: 'Created' },
            UPDATE: { icon: 'bi-pencil-fill', cls: 'blue', label: 'Updated' },
            DELETE: { icon: 'bi-trash-fill', cls: 'red', label: 'Deleted' },
            LOGIN: { icon: 'bi-person-check-fill', cls: 'green', label: 'Logged in' },
            LOGOUT: { icon: 'bi-box-arrow-right', cls: 'teal', label: 'Logged out' },
        };

        async function loadActivity() {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>`;
            try {
                const logs = await apiGet('/activity-logs/?limit=10');
                if (!logs.length) {
                    feed.innerHTML = `<p class="text-muted small text-center py-4">No recent activity.</p>`;
                    return;
                }
                feed.innerHTML = logs.map(log => {
                    const m = ACTION_META[log.action] || { icon: 'bi-activity', cls: 'teal', label: log.action };
                    return `
                <div class="activity-item">
                    <div class="activity-icon ${m.cls}"><i class="bi ${m.icon}"></i></div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold small">${m.label}: ${log.entity_type}</div>
                        <div class="text-muted" style="font-size:0.78rem;">
                            User #${log.user_id} · ${log.user_role.replace(/_/g, ' ')}
                        </div>
                    </div>
                    <div class="text-muted d-flex align-items-center gap-1" style="font-size:0.78rem;white-space:nowrap;">
                        <i class="bi bi-clock"></i> ${timeAgo(log.created_at)}
                    </div>
                </div>`;
                }).join('');
            } catch (e) {
                feed.innerHTML = `<p class="text-muted small text-center py-4">
                <i class="bi bi-wifi-off me-1"></i>Activity logs unavailable (admin only).
            </p>`;
            }
        }

        // ── Open Issues ───────────────────────────────────────────────────
        async function loadOpenIssues() {
            const el = document.getElementById('open-issues-list');
            try {
                const issues = await apiGet('/issues/?status=OPEN&limit=5');
                if (!issues.length) {
                    el.innerHTML = `<div class="text-center py-4 text-success">
                    <i class="bi bi-check2-circle" style="font-size:2rem;"></i>
                    <p class="mt-2 small mb-0">No open issues! Great job.</p></div>`;
                    return;
                }
                el.innerHTML = issues.map(i => `
            <div class="task-item">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge ${sevBadge(i.severity)} rounded-pill" style="font-size:0.68rem;">${i.severity || '?'}</span>
                    <span class="small fw-semibold text-truncate" style="max-width:170px;">${i.title}</span>
                </div>
                <span class="text-muted small">#${i.client_id}</span>
            </div>`).join('');
            } catch (e) {
                el.innerHTML = `<p class="text-muted small text-center py-4">Could not load issues.</p>`;
            }
        }

        // ── Clients table ─────────────────────────────────────────────────
        async function loadClients() {
            const tbody = document.getElementById('clients-table');
            try {
                const clients = await apiGet('/clients/?limit=6&sort_by=created_at&sort_order=desc');
                if (!clients.length) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No clients yet.</td></tr>`;
                    return;
                }
                tbody.innerHTML = clients.map(c => `
            <tr>
                <td class="fw-semibold">${c.name}</td>
                <td class="text-muted small">${c.organization || '—'}</td>
                <td><span class="badge rounded-pill ${c.status === 'ACTIVE' ? 'badge-success' : 'bg-secondary'}"
                    style="font-size:0.68rem;">${c.status || 'NEW'}</span></td>
                <td>${c.pm_id ? `<span class="badge badge-primary rounded-pill" style="font-size:0.68rem;">PM #${c.pm_id}</span>` : '<span class="text-muted small">Unassigned</span>'}</td>
            </tr>`).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Could not load clients.</td></tr>`;
            }
        }

        // ── Employees list ────────────────────────────────────────────────
        async function loadEmployees() {
            const el = document.getElementById('employees-list');
            try {
                const emps = await apiGet('/employees/?limit=5');
                if (!emps.length) {
                    el.innerHTML = `<p class="text-muted small text-center py-3">No employees found.</p>`;
                    return;
                }
                el.innerHTML = emps.map(e => {
                    const initials = (e.full_name || e.user?.name || 'EMP').slice(0, 2).toUpperCase();
                    const name = e.full_name || e.user?.name || `Employee #${e.id}`;
                    const role = (e.department || e.user?.role || '').replace(/_/g, ' ');
                    return `
                <div class="d-flex align-items-center gap-3 py-2" style="border-bottom:1px solid #f1f5f9;">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0"
                        style="width:36px;height:36px;font-size:0.75rem;">${initials}</div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-semibold small text-truncate">${name}</div>
                        <div class="text-muted" style="font-size:0.72rem;">${role}</div>
                    </div>
                </div>`;
                }).join('');
            } catch (e) {
                el.innerHTML = `<p class="text-muted small text-center py-3">Could not load team (admin only).</p>`;
            }
        }

        // ── Main loader ───────────────────────────────────────────────────
        async function loadDashboard() {
            try {
                // Load pre-aggregated stats from backend
                const stats = await apiGet('/reports/dashboard');

                // Update KPIs
                document.getElementById('kpi-leads').textContent = stats.total_leads.toLocaleString('en-IN');
                document.getElementById('kpi-leads-trend').innerHTML =
                    `<i class="bi bi-bullseye text-success"></i> <span class="text-success fw-semibold">${stats.visit_status_breakdown['COMPLETED'] || 0}</span>
                 <span class="text-muted fw-normal small"> completed visits</span>`;

                document.getElementById('kpi-clients').textContent = stats.active_clients.toLocaleString('en-IN');
                document.getElementById('kpi-clients-trend').innerHTML =
                    `<i class="bi bi-people text-primary"></i> <span class="text-primary fw-semibold">${stats.ongoing_projects}</span>
                 <span class="text-muted fw-normal small"> with PM assigned</span>`;

                document.getElementById('kpi-issues').textContent = stats.open_issues.toLocaleString('en-IN');
                const highSevCount = stats.issue_severity_breakdown['HIGH'] || 0;
                document.getElementById('kpi-issues-trend').innerHTML =
                    highSevCount > 0
                        ? `<i class="bi bi-exclamation-triangle-fill text-danger"></i> <span class="text-danger fw-semibold">${highSevCount}</span> <span class="text-muted fw-normal small">critical</span>`
                        : `<i class="bi bi-check-circle text-success"></i> <span class="text-muted fw-normal small">No critical issues</span>`;

                document.getElementById('kpi-visits').textContent = stats.total_leads.toLocaleString('en-IN');
                const scheduled = stats.visit_status_breakdown['SCHEDULED'] || 0;
                document.getElementById('kpi-visits-trend').innerHTML =
                    `<i class="bi bi-calendar-check text-info"></i> <span class="text-info fw-semibold">${scheduled}</span>
                 <span class="text-muted fw-normal small"> scheduled</span>`;

                // Charts
                initCharts(stats);

            } catch (e) {
                console.error("Dashboard Stats Error:", e);
                ['kpi-leads', 'kpi-clients', 'kpi-issues', 'kpi-visits'].forEach(id => {
                    document.getElementById(id).textContent = '—';
                });
            }

            // Panels (Individual lists still fetch their own data for detailed view)
            await Promise.allSettled([
                loadActivity(),
                loadOpenIssues(),
                loadClients(),
                loadEmployees()
            ]);
        }

        loadDashboard();
    </script>
</body>

</html>