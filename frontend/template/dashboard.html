<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard — CRM AI SETU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>

<body class="bg-light">
    <div class="d-flex">
        <div id="sidebar"></div>

        <div class="flex-grow-1">
            <!-- Top header injected by auth.js -->

            <div class="page-content">

                <!-- Page Title -->
                <div class="mb-4">
                    <h2 class="fw-bold fs-3 mb-1">Dashboard</h2>
                    <p class="text-muted mb-0" style="font-size:0.93rem;">
                        Welcome back! Here's what's happening today — <span id="today-date"></span>
                    </p>
                </div>

                <!-- KPI Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <a href="visits.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100 p-3"
                                style="cursor:pointer;border-radius:12px;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="kpi-title text-uppercase text-muted fw-semibold"
                                        style="letter-spacing:0.5px;font-size:0.75rem;">Total Leads</div>
                                    <div class="kpi-icon-wrapper rounded-circle d-flex align-items-center justify-content-center"
                                        style="width:36px;height:36px;background:#f5f3ff;color:#7c3aed;">
                                        <i class="bi bi-bullseye fs-6"></i>
                                    </div>
                                </div>
                                <div class="kpi-value fs-3 fw-bold text-dark mb-1" id="kpi-leads">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend mt-auto" style="font-size:0.8rem;" id="kpi-leads-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="clients.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100 p-3"
                                style="cursor:pointer;border-radius:12px;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="kpi-title text-uppercase text-muted fw-semibold"
                                        style="letter-spacing:0.5px;font-size:0.75rem;">Active Clients</div>
                                    <div class="kpi-icon-wrapper rounded-circle d-flex align-items-center justify-content-center"
                                        style="width:36px;height:36px;background:#f0fdfa;color:#0d9488;">
                                        <i class="bi bi-people fs-6"></i>
                                    </div>
                                </div>
                                <div class="kpi-value fs-3 fw-bold text-dark mb-1" id="kpi-clients">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend mt-auto" style="font-size:0.8rem;" id="kpi-clients-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="projects.html" class="text-decoration-none h-100">
                            <div class="card border-0 shadow-sm kpi-card h-100 p-3"
                                style="cursor:pointer;border-radius:12px;">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="kpi-title text-uppercase text-muted fw-semibold"
                                        style="letter-spacing:0.5px;font-size:0.75rem;">Ongoing Projects</div>
                                    <div class="kpi-icon-wrapper rounded-circle d-flex align-items-center justify-content-center"
                                        style="width:36px;height:36px;background:#fef3c7;color:#d97706;">
                                        <i class="bi bi-briefcase fs-6"></i>
                                    </div>
                                </div>
                                <div class="kpi-value fs-3 fw-bold text-dark mb-1" id="kpi-projects">
                                    <span class="spinner-border spinner-border-sm text-muted"></span>
                                </div>
                                <div class="kpi-trend mt-auto" style="font-size:0.8rem;" id="kpi-projects-trend">—</div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm kpi-card h-100 p-3"
                            style="cursor:pointer;border-radius:12px;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="kpi-title text-uppercase text-muted fw-semibold"
                                    style="letter-spacing:0.5px;font-size:0.75rem;">Revenue (MTD)</div>
                                <div class="kpi-icon-wrapper rounded-circle d-flex align-items-center justify-content-center"
                                    style="width:36px;height:36px;background:#dcfce7;color:#16a34a;">
                                    <i class="bi bi-currency-rupee fs-6"></i>
                                </div>
                            </div>
                            <div class="kpi-value fs-3 fw-bold text-dark mb-1" id="kpi-revenue">
                                <span class="spinner-border spinner-border-sm text-muted"></span>
                            </div>
                            <div class="kpi-trend mt-auto" style="font-size:0.8rem;" id="kpi-revenue-trend">—</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-3 mb-4">
                    <!-- Leads by Month -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 p-4" style="border-radius:12px;">
                            <h6 class="fw-bold mb-3">Leads by Month</h6>
                            <div style="position: relative; height: 230px;">
                                <canvas id="leadsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Revenue Trend -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 p-4" style="border-radius:12px;">
                            <h6 class="fw-bold mb-3">Revenue Trend</h6>
                            <div style="position: relative; height: 230px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Lead Sources -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 p-4 d-flex flex-column" style="border-radius:12px;">
                            <h6 class="fw-bold mb-3">Lead Sources</h6>
                            <div class="d-flex justify-content-center mb-3 flex-grow-1"
                                style="position: relative; height: 200px;">
                                <canvas id="sourcesChart"></canvas>
                            </div>
                            <div id="sources-legend" class="d-flex flex-wrap justify-content-center gap-3 mt-auto"
                                style="font-size:0.75rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Activity + Tasks Row -->
                <div class="row g-3">
                    <!-- Recent Activity (from activity logs API) -->
                    <div class="col-md-7">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Recent Activity</h6>
                                <button onclick="loadActivity()" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;font-size:0.8rem;">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                            </div>
                            <div id="activity-feed">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm"></div>
                                    <p class="mt-2 small">Loading activity...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Open Issues Table -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm h-100 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Open Issues</h6>
                                <a href="issues.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;font-size:0.8rem;">View All</a>
                            </div>
                            <div id="open-issues-list">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients + Employees Row -->
                <div class="row g-3 mt-1">
                    <!-- Recent Clients -->
                    <div class="col-md-7">
                        <div class="card border-0 shadow-sm">
                            <div
                                class="card-header bg-white border-0 pt-4 pb-2 px-4 d-flex justify-content-between align-items-center">
                                <span class="fw-bold"><i class="bi bi-people me-2 text-primary"></i>Recent
                                    Clients</span>
                                <a href="clients.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <table class="table mb-0" style="font-size:0.875rem;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Organisation</th>
                                            <th>Status</th>
                                            <th>PM</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clients-table">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <div class="spinner-border spinner-border-sm"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Employees quick view -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm">
                            <div
                                class="card-header bg-white border-0 pt-4 pb-2 px-4 d-flex justify-content-between align-items-center">
                                <span class="fw-bold"><i class="bi bi-person-badge me-2 text-primary"></i>Team
                                    Members</span>
                                <a href="hrm.html" class="btn btn-sm text-primary fw-semibold"
                                    style="background:#eef2ff;">HR &amp; Payroll</a>
                            </div>
                            <div class="card-body p-0">
                                <div id="employees-list" class="px-3 pb-3">
                                    <div class="text-center text-muted py-4">
                                        <div class="spinner-border spinner-border-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /page-content -->
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/components.js?v=2.1"></script>
    <script src="../js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        requireAuth();
        document.getElementById('sidebar').innerHTML = renderSidebar('dashboard');
        document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        // ── Utility ─────────────────────────────────────────────────────
        function timeAgo(dateStr) {
            if (!dateStr) return '—';
            const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function sevBadge(sev) {
            const map = { HIGH: 'bg-danger', MEDIUM: 'bg-warning text-dark', LOW: 'bg-success' };
            return map[sev] || 'bg-secondary';
        }

        function statusBadge(status) {
            const map = {
                ACCEPT: 'badge-success', SATISFIED: 'badge-primary',
                DECLINE: 'badge-danger', THINKING: 'badge-warning',
                SCHEDULED: 'bg-info text-white', OTHER: 'bg-secondary'
            };
            return map[(status || '').toUpperCase()] || 'bg-secondary';
        }

        // ── Charts (now using backend-aggregated data) ──────────────────
        let leadsChartObj, revenueChartObj, sourcesChartObj;

        function initCharts(stats) {
            Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";

            // 1. Leads by Month (bar)
            try {
                let labels = Object.keys(stats.leads_by_month);
                let data = Object.values(stats.leads_by_month);
                if (labels.length === 0) { labels = ['No Data']; data = [0]; }

                if (leadsChartObj) leadsChartObj.destroy();
                leadsChartObj = new Chart(document.getElementById('leadsChart'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Leads', data,
                            backgroundColor: '#4f46e5', borderRadius: 4, barPercentage: 0.6
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, border: { display: false }, grid: { color: '#f1f5f9', drawTicks: false }, ticks: { font: { size: 10 }, padding: 10, stepSize: 35 } },
                            x: { border: { display: false }, grid: { display: false }, ticks: { font: { size: 10 } } }
                        },
                        maintainAspectRatio: false
                    }
                });
            } catch (e) { console.error("Leads Chart Error:", e); }

            // 2. Revenue Trend (Line)
            try {
                let rLabels = Object.keys(stats.revenue_by_month);
                let rData = Object.values(stats.revenue_by_month);
                if (rLabels.length === 0) { rLabels = ['No Data']; rData = [0]; }

                if (revenueChartObj) revenueChartObj.destroy();
                revenueChartObj = new Chart(document.getElementById('revenueChart'), {
                    type: 'line',
                    data: {
                        labels: rLabels,
                        datasets: [{
                            label: 'Revenue', data: rData,
                            borderColor: '#10b981', backgroundColor: '#10b981',
                            tension: 0.4, borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true, border: { display: false }, grid: { color: '#f1f5f9' },
                                ticks: { font: { size: 10 }, callback: (value) => '₹' + (value >= 1000 ? (value / 1000) + 'K' : value) }
                            },
                            x: { border: { display: false }, grid: { display: false }, ticks: { font: { size: 10 } } }
                        },
                        maintainAspectRatio: false
                    }
                });
            } catch (e) { console.error("Revenue Chart Error:", e); }

            // 3. Lead Sources (Donut)
            try {
                let sData = stats.lead_sources_breakdown;
                if (Object.keys(sData).length === 0) { sData = { 'No Data': 1 }; }

                const sLabels = Object.keys(sData);
                const sValues = Object.values(sData);
                const sColors = ['#4f46e5', '#06b6d4', '#f59e0b', '#10b981', '#94a3b8'];

                if (sourcesChartObj) sourcesChartObj.destroy();
                sourcesChartObj = new Chart(document.getElementById('sourcesChart'), {
                    type: 'doughnut',
                    data: {
                        labels: sLabels,
                        datasets: [{ data: sValues, backgroundColor: sColors, borderWidth: 2, borderColor: '#fff' }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        cutout: '70%',
                        maintainAspectRatio: false
                    }
                });

                document.getElementById('sources-legend').innerHTML = sLabels.map((s, i) =>
                    `<div class="d-flex align-items-center gap-2 fw-medium text-secondary">
                        <span style="width:10px;height:10px;background:${sColors[i % sColors.length]};border-radius:50%;display:inline-block;"></span> 
                        <span>${s}</span>
                    </div>`
                ).join('');
            } catch (e) { console.error("Sources Chart Error:", e); }
        }

        // ── Activity Feed ─────────────────────────────────────────────────
        const ACTION_META = {
            CREATE: { icon: 'bi-plus-lg', bg: '#e0e7ff', color: '#4f46e5', label: 'Created' },
            UPDATE: { icon: 'bi-pencil-fill', bg: '#e0f2fe', color: '#0ea5e9', label: 'Updated' },
            DELETE: { icon: 'bi-trash-fill', bg: '#ffe4e6', color: '#e11d48', label: 'Deleted' },
            LOGIN: { icon: 'bi-box-arrow-in-right', bg: '#dcfce7', color: '#16a34a', label: 'Logged in' },
            LOGOUT: { icon: 'bi-box-arrow-right', bg: '#f1f5f9', color: '#64748b', label: 'Logged out' },
        };

        async function loadActivity() {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>`;
            try {
                const logs = await apiGet('/activity-logs/?limit=10');
                if (!logs.length) {
                    feed.innerHTML = `<p class="text-muted small text-center py-4">No recent activity.</p>`;
                    return;
                }
                feed.innerHTML = logs.map(log => {
                    const m = ACTION_META[log.action] || { icon: 'bi-activity', bg: '#f1f5f9', color: '#64748b', label: log.action };
                    return `
                <div class="d-flex align-items-start gap-3 py-3 border-bottom position-relative">
                    <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 38px; height: 38px; background-color: ${m.bg}; color: ${m.color}; z-index: 2;">
                        <i class="bi ${m.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold text-dark" style="font-size: 0.85rem;">${m.label}: <span class="text-primary">${log.entity_type}</span></span>
                            <span class="text-muted small"><i class="bi bi-clock me-1"></i>${timeAgo(log.created_at)}</span>
                        </div>
                        <div class="text-muted" style="font-size: 0.80rem;">
                            <i class="bi bi-person me-1"></i>User #${log.user_id} &middot; ${log.user_role.replace(/_/g, ' ')}
                        </div>
                    </div>
                </div>`;
                }).join('');
            } catch (e) {
                feed.innerHTML = `<p class="text-muted small text-center py-4">
                <i class="bi bi-wifi-off me-1"></i>Activity logs unavailable (admin only).
            </p>`;
            }
        }

        // ── Open Issues ───────────────────────────────────────────────────
        function stBadge(status) {
            const stStyle = {
                PENDING: 'color: #d39e00; background-color: #fff8e1;',
                SOLVED: 'color: #0ea5e9; background-color: #e0f2fe;',
                COMPLETED: 'color: #198754; background-color: #e8f5e9;',
                CANCEL: 'color: #dc3545; background-color: #ffeef0;'
            };
            const stLabel = (status || 'PENDING').replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
            return `<span class="badge rounded-pill fw-medium px-2 py-1" style="${stStyle[status] || stStyle.PENDING} font-size: 0.70rem;">${stLabel}</span>`;
        }

        async function loadOpenIssues() {
            const el = document.getElementById('open-issues-list');
            try {
                const issues = await apiGet('/issues/?limit=5');
                const openIssues = issues.filter(i => i.status === 'PENDING').slice(0, 5);
                if (!openIssues.length) {
                    el.innerHTML = `<div class="text-center py-4 text-success">
                    <i class="bi bi-check-circle" style="font-size:2rem;"></i>
                    <p class="mt-2 small mb-0 fw-semibold">No open issues! Great job.</p></div>`;
                    return;
                }
                el.innerHTML = openIssues.map(i => `
            <div class="task-item d-flex justify-content-between align-items-center py-3 border-bottom">
                <div>
                    <div class="fw-semibold text-dark mb-1 d-flex align-items-center gap-2">
                        ${i.title}
                    </div>
                </div>
                <div>
                    ${stBadge(i.status)}
                </div>
            </div>`).join('');
            } catch (e) {
                el.innerHTML = `<p class="text-muted small text-center py-4">Could not load issues.</p>`;
            }
        }

        // ── Clients table ─────────────────────────────────────────────────
        async function loadClients() {
            const tbody = document.getElementById('clients-table');
            try {
                const clients = await apiGet('/clients/?limit=6&sort_by=created_at&sort_order=desc');
                if (!clients.length) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No clients yet.</td></tr>`;
                    return;
                }
                tbody.innerHTML = clients.map(c => `
            <tr class="align-middle">
                <td class="fw-semibold text-dark">
                   <div class="d-flex align-items-center gap-2">
                      <div class="rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center fw-bold" style="width:32px;height:32px;font-size:12px;">
                          ${c.name.substring(0, 2).toUpperCase()}
                      </div>
                      ${c.name}
                   </div>
                </td>
                <td class="text-secondary small fw-medium">${c.organization || '—'}</td>
                <td>
                    <span class="badge rounded-pill fw-medium px-2 py-1" style="${c.status === 'ACTIVE' ? 'color: #0d9488; background-color: #ccfbf1;' : 'color: #64748b; background-color: #f1f5f9;'} font-size:0.70rem;">
                        ${(c.status || 'NEW').replace('_', ' ')}
                    </span>
                </td>
                <td>${c.pm_id ? `<span class="badge rounded-pill px-2 py-1 mx-0 fw-medium" style="color: #4f46e5; background-color: #e0e7ff; font-size:0.70rem;"><i class="bi bi-person-fill me-1"></i>PM #${c.pm_id}</span>` : '<span class="text-muted small">Unassigned</span>'}</td>
            </tr>`).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Could not load clients.</td></tr>`;
            }
        }

        // ── Employees list ────────────────────────────────────────────────
        async function loadEmployees() {
            const el = document.getElementById('employees-list');
            try {
                const emps = await apiGet('/employees/?limit=5');
                if (!emps.length) {
                    el.innerHTML = `<p class="text-muted small text-center py-3">No employees found.</p>`;
                    return;
                }
                const pastelColors = ['#e0e7ff', '#fce7f3', '#dcfce7', '#fef3c7', '#e0f2fe'];
                const textColors = ['#4f46e5', '#db2777', '#16a34a', '#d97706', '#0ea5e9'];
                el.innerHTML = emps.map((e, idx) => {
                    const initials = (e.full_name || e.user?.name || 'EM').slice(0, 2).toUpperCase();
                    const name = e.full_name || e.user?.name || `Employee #${e.id}`;
                    const role = (e.department || e.user?.role || '').replace(/_/g, ' ');
                    const bg = pastelColors[idx % pastelColors.length];
                    const fg = textColors[idx % textColors.length];
                    return `
                <div class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold flex-shrink-0"
                        style="width: 38px; height: 38px; font-size: 0.80rem; background-color: ${bg}; color: ${fg};">
                        ${initials}
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-semibold text-dark text-truncate" style="font-size: 0.90rem;">${name}</div>
                        <div class="text-muted" style="font-size: 0.75rem;"><i class="bi bi-briefcase me-1"></i>${role}</div>
                    </div>
                </div>`;
                }).join('');
            } catch (e) {
                el.innerHTML = `<p class="text-muted small text-center py-3">Could not load team (admin only).</p>`;
            }
        }

        // ── Main loader ───────────────────────────────────────────────────
        function formatTrend(pct) {
            const isPos = pct >= 0;
            const color = isPos ? 'text-success' : 'text-danger';
            const icon = isPos ? 'bi-arrow-up-right' : 'bi-arrow-down-right';
            const prefix = isPos ? '+' : '';
            return `<span class="${color} fw-medium"><i class="bi ${icon}"></i> ${prefix}${pct}%</span> <span class="text-muted">vs last month</span>`;
        }

        async function loadDashboard() {
            try {
                // Load pre-aggregated stats from backend
                const stats = await apiGet('/reports/dashboard');

                // Update KPIs
                document.getElementById('kpi-leads').textContent = stats.total_leads.toLocaleString('en-IN');
                document.getElementById('kpi-leads-trend').innerHTML = formatTrend(stats.leads_mom_pct);

                document.getElementById('kpi-clients').textContent = stats.active_clients.toLocaleString('en-IN');
                document.getElementById('kpi-clients-trend').innerHTML = formatTrend(stats.clients_mom_pct);

                document.getElementById('kpi-projects').textContent = stats.ongoing_projects.toLocaleString('en-IN');
                document.getElementById('kpi-projects-trend').innerHTML = formatTrend(stats.projects_mom_pct);

                // Format Revenue (e.g. 24.5L, 300K, etc.)
                let revText = '₹' + stats.revenue_mtd.toLocaleString('en-IN');
                if (stats.revenue_mtd >= 100000) {
                    revText = '₹' + (stats.revenue_mtd / 100000).toFixed(1) + 'L';
                } else if (stats.revenue_mtd >= 1000) {
                    revText = '₹' + (stats.revenue_mtd / 1000).toFixed(1) + 'K';
                }
                document.getElementById('kpi-revenue').textContent = revText;
                document.getElementById('kpi-revenue-trend').innerHTML = formatTrend(stats.revenue_mom_pct);

                // Charts
                initCharts(stats);

            } catch (e) {
                console.error("Dashboard Stats Error:", e);
                ['leads', 'clients', 'projects', 'revenue'].forEach(id => {
                    const el = document.getElementById('kpi-' + id);
                    if (el) el.textContent = '—';
                });
            }

            // Panels (Individual lists still fetch their own data for detailed view)
            await Promise.allSettled([
                loadActivity(),
                loadOpenIssues(),
                loadClients(),
                loadEmployees()
            ]);
        }

        loadDashboard();
    </script>
</body>

</html>